{"version":3,"sources":["Webpack.ts"],"names":["HOST","getenv","string","DEFAULT_PORT","int","WEBPACK_LOG_TAG","webpackDevServerInstance","webpackServerPort","startAsync","projectRoot","options","deprecatedVerbose","XDLError","usingNextJs","getProjectUseNextJsAsync","unimodulesOnly","serverName","ProjectUtils","logError","env","config","createWebpackConfigAsync","port","getAvailablePortAsync","defaultPort","logInfo","chalk","underline","mode","protocol","https","urls","useYarn","ConfigUtils","isUsingYarn","appName","getProjectNameAsync","nonInteractive","validateBoolOption","process","stdout","isTTY","server","Error","startNextJsAsync","dev","development","expoWebpackConfig","isFirstCompile","Promise","resolve","compiler","webpackFactory","webpack","onFinished","WebpackDevServer","devServer","listen","error","message","onWebpackFinished","ProjectSettings","setPackagerInfoAsync","host","ip","address","url","stopAsync","close","openAsync","Web","openProjectAsync","bundleAsync","bundleNextJsAsync","stats","warnings","reject","run","messages","errors","_showErrors","_showWarnings","toJson","all","length","join","CI","toLowerCase","console","log","yellow","green","red","exp","readConfigJsonAsync","webName","getNameFromConfig","use","web","getServer","getPort","getUrlAsync","getProtocolAsync","readAsync","setMode","BABEL_ENV","NODE_ENV","name","value","defaultValue","transformCLIOptions","isImageEditingEnabled","pwa","isPolyfillEnabled","polyfill","fullOptions","isValidationEnabled","Doctor","validateWebSupportAsync","getWebpackConfigEnvFromBundlingOptionsAsync","withUnimodules","require","invokeWebpackConfigAsync","applyOptionsToProjectSettingsAsync","newSettings","Object","keys","setAsync","isDebugInfoEnabled","isInfoEnabled","production","info","webpackEnv","next","resolveModule","_copyCustomNextJsTemplatesAsync","app","dir","conf","_createNextJsConfig","handle","getRequestHandler","prepare","get","err","toString","nextBuild","default","userNextJsConfig","userNextConfigJsPath","path","fs","existsSync","expoBabelLoader","_findBabelLoader","module","rules","includeFunc","include","pageExtensions","extensions","map","substr","nextjsWebpackConfig","newConfig","symlinks","alias","resolveLoader","plugins","externals","external","ctx","req","cb","rule","loader","includes","writeFile","nextJsDocument","e","pagesDocument","nextJsImportDocument"],"mappings":"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","sourcesContent":["import * as ConfigUtils from '@expo/config';\nimport fs from 'fs-extra';\nimport path from 'path';\nimport chalk from 'chalk';\nimport formatWebpackMessages from 'react-dev-utils/formatWebpackMessages';\nimport { choosePort, prepareUrls } from 'react-dev-utils/WebpackDevServerUtils';\nimport webpack from 'webpack';\nimport WebpackDevServer from 'webpack-dev-server';\nimport express from 'express';\nimport http from 'http';\n\nimport getenv from 'getenv';\nimport createWebpackCompiler, { printSuccessMessages } from './createWebpackCompiler';\nimport ip from './ip';\nimport * as ProjectUtils from './project/ProjectUtils';\nimport * as ProjectSettings from './ProjectSettings';\nimport * as Web from './Web';\n// @ts-ignore missing types for Doctor until it gets converted to TypeScript\nimport * as Doctor from './project/Doctor';\nimport XDLError from './XDLError';\nimport { User as ExpUser } from './User';\n\nexport const HOST = getenv.string('WEB_HOST', '0.0.0.0');\nexport const DEFAULT_PORT = getenv.int('WEB_PORT', 19006);\nconst WEBPACK_LOG_TAG = 'expo';\n\nexport type DevServer = WebpackDevServer | http.Server;\n\nlet webpackDevServerInstance: DevServer | null = null;\nlet webpackServerPort: number | null = null;\n\ntype CLIWebOptions = {\n  dev?: boolean;\n  polyfill?: boolean;\n  pwa?: boolean;\n  nonInteractive?: boolean;\n  port?: number;\n  unimodulesOnly?: boolean;\n  onWebpackFinished?: (error?: Error) => void;\n};\n\ntype BundlingOptions = {\n  dev?: boolean;\n  polyfill?: boolean;\n  pwa?: boolean;\n  isValidationEnabled?: boolean;\n  isImageEditingEnabled?: boolean;\n  isDebugInfoEnabled?: boolean;\n  isPolyfillEnabled?: boolean;\n  webpackEnv?: Object;\n  mode?: 'development' | 'production' | 'test' | 'none';\n  https?: boolean;\n  nonInteractive?: boolean;\n  unimodulesOnly?: boolean;\n  onWebpackFinished?: (error?: Error) => void;\n};\n\nexport async function startAsync(\n  projectRoot: string,\n  options: CLIWebOptions = {},\n  deprecatedVerbose?: boolean\n): Promise<{\n  url: string;\n  server: DevServer;\n  port: number;\n  protocol: 'http' | 'https';\n  host?: string;\n} | null> {\n  if (typeof deprecatedVerbose !== 'undefined') {\n    throw new XDLError(\n      'WEBPACK_DEPRECATED',\n      'startAsync(root, options, verbose): The `verbose` option is deprecated.'\n    );\n  }\n\n  const usingNextJs = await getProjectUseNextJsAsync(projectRoot);\n  options.unimodulesOnly = usingNextJs;\n  let serverName = 'Webpack';\n  if (usingNextJs) {\n    serverName = 'Next.js';\n  }\n\n  if (webpackDevServerInstance) {\n    ProjectUtils.logError(projectRoot, WEBPACK_LOG_TAG, `${serverName} is already running.`);\n    return null;\n  }\n\n  const { env, config } = await createWebpackConfigAsync(projectRoot, options);\n\n  const port = await getAvailablePortAsync({\n    defaultPort: options.port,\n  });\n  webpackServerPort = port;\n\n  ProjectUtils.logInfo(\n    projectRoot,\n    WEBPACK_LOG_TAG,\n    `Starting ${serverName} on port ${webpackServerPort} in ${chalk.underline(env.mode)} mode.`\n  );\n\n  const protocol = env.https ? 'https' : 'http';\n  const urls = prepareUrls(protocol, '::', webpackServerPort);\n  const useYarn = ConfigUtils.isUsingYarn(projectRoot);\n  const appName = await getProjectNameAsync(projectRoot);\n  const nonInteractive = validateBoolOption(\n    'nonInteractive',\n    options.nonInteractive,\n    !!process.stdout.isTTY\n  );\n\n  let server: DevServer;\n  if (usingNextJs) {\n    if (protocol === 'https') {\n      // TODO: Support https.\n      throw new Error('https with Next.js is not supported for now.');\n    }\n    server = await startNextJsAsync({\n      projectRoot,\n      port: webpackServerPort,\n      dev: env.development,\n      expoWebpackConfig: config,\n    });\n    printSuccessMessages({\n      projectRoot,\n      appName,\n      urls,\n      config,\n      isFirstCompile: true,\n      nonInteractive,\n    });\n  } else {\n    server = await new Promise(resolve => {\n      // Create a webpack compiler that is configured with custom messages.\n      const compiler = createWebpackCompiler({\n        projectRoot,\n        nonInteractive,\n        webpackFactory: webpack,\n        appName,\n        config,\n        urls,\n        useYarn,\n        onFinished: () => resolve(server),\n      });\n      const server = new WebpackDevServer(compiler, config.devServer);\n      // Launch WebpackDevServer.\n      server.listen(port, HOST, error => {\n        if (error) {\n          ProjectUtils.logError(projectRoot, WEBPACK_LOG_TAG, error.message);\n        }\n        if (typeof options.onWebpackFinished === 'function') {\n          options.onWebpackFinished(error);\n        }\n      });\n      webpackDevServerInstance = server;\n    });\n  }\n  await ProjectSettings.setPackagerInfoAsync(projectRoot, {\n    webpackServerPort,\n  });\n\n  const host = ip.address();\n  const url = `${protocol}://${host}:${webpackServerPort}`;\n  return {\n    url,\n    server,\n    port,\n    protocol,\n    host,\n  };\n}\n\nexport async function stopAsync(projectRoot: string): Promise<void> {\n  if (webpackDevServerInstance) {\n    const server = webpackDevServerInstance;\n    await new Promise(resolve => server.close(() => resolve()));\n    webpackDevServerInstance = null;\n    webpackServerPort = null;\n    await ProjectSettings.setPackagerInfoAsync(projectRoot, {\n      webpackServerPort: null,\n    });\n  }\n}\n\nexport async function openAsync(projectRoot: string, options?: BundlingOptions): Promise<void> {\n  if (!webpackDevServerInstance) {\n    await startAsync(projectRoot, options);\n  }\n  await Web.openProjectAsync(projectRoot);\n}\n\nexport async function bundleAsync(projectRoot: string, options?: BundlingOptions): Promise<void> {\n  const usingNextJs = await getProjectUseNextJsAsync(projectRoot);\n\n  const { config } = await createWebpackConfigAsync(projectRoot, {\n    ...options,\n    unimodulesOnly: usingNextJs,\n  });\n\n  if (usingNextJs) {\n    await bundleNextJsAsync({ projectRoot, expoWebpackConfig: config });\n  } else {\n    const compiler = webpack(config);\n\n    try {\n      // We generate the stats.json file in the webpack-config\n      const { stats, warnings } = await new Promise((resolve, reject) =>\n        compiler.run((error, stats) => {\n          let messages;\n          if (error) {\n            if (!error.message) {\n              return reject(error);\n            }\n            messages = formatWebpackMessages({\n              errors: [error.message],\n              warnings: [],\n              _showErrors: true,\n              _showWarnings: true,\n            });\n          } else {\n            messages = formatWebpackMessages(\n              stats.toJson({ all: false, warnings: true, errors: true })\n            );\n          }\n\n          if (messages.errors.length) {\n            // Only keep the first error. Others are often indicative\n            // of the same problem, but confuse the reader with noise.\n            if (messages.errors.length > 1) {\n              messages.errors.length = 1;\n            }\n            return reject(new Error(messages.errors.join('\\n\\n')));\n          }\n          if (\n            process.env.CI &&\n            (typeof process.env.CI !== 'string' || process.env.CI.toLowerCase() !== 'false') &&\n            messages.warnings.length\n          ) {\n            console.log(\n              chalk.yellow(\n                '\\nTreating warnings as errors because process.env.CI = true.\\n' +\n                  'Most CI servers set it automatically.\\n'\n              )\n            );\n            return reject(new Error(messages.warnings.join('\\n\\n')));\n          }\n\n          resolve({\n            stats,\n            warnings: messages.warnings,\n          });\n        })\n      );\n\n      if (warnings.length) {\n        console.log(chalk.yellow('Compiled with warnings.\\n'));\n        console.log(warnings.join('\\n\\n'));\n      } else {\n        console.log(chalk.green('Compiled successfully.\\n'));\n      }\n    } catch (error) {\n      console.log(chalk.red('Failed to compile.\\n'));\n      throw error;\n    }\n  }\n}\n\nexport async function getProjectNameAsync(projectRoot: string): Promise<string> {\n  const { exp } = await ConfigUtils.readConfigJsonAsync(projectRoot);\n  const { webName } = ConfigUtils.getNameFromConfig(exp);\n  return webName;\n}\n\nexport async function getProjectUseNextJsAsync(projectRoot: string): Promise<boolean> {\n  const { exp } = await ConfigUtils.readConfigJsonAsync(projectRoot);\n  const { use = null } = exp.web || {};\n  return use === 'nextjs';\n}\n\nexport function getServer(projectRoot: string): DevServer | null {\n  if (webpackDevServerInstance == null) {\n    ProjectUtils.logError(projectRoot, WEBPACK_LOG_TAG, 'Webpack is not running.');\n  }\n  return webpackDevServerInstance;\n}\n\nexport function getPort(): number | null {\n  return webpackServerPort;\n}\n\nexport async function getUrlAsync(projectRoot: string): Promise<string | null> {\n  const devServer = getServer(projectRoot);\n  if (!devServer) {\n    return null;\n  }\n  const host = ip.address();\n  const protocol = await getProtocolAsync(projectRoot);\n  return `${protocol}://${host}:${webpackServerPort}`;\n}\n\nexport async function getProtocolAsync(projectRoot: string): Promise<'http' | 'https'> {\n  // TODO: Bacon: Handle when not in expo\n  const { https } = await ProjectSettings.readAsync(projectRoot);\n  return https === true ? 'https' : 'http';\n}\n\nexport async function getAvailablePortAsync(\n  options: { host?: string; defaultPort?: number } = {}\n): Promise<number> {\n  try {\n    const defaultPort =\n      'defaultPort' in options && options.defaultPort ? options.defaultPort : DEFAULT_PORT;\n    const port = await choosePort(\n      'host' in options && options.host ? options.host : HOST,\n      defaultPort\n    );\n    if (!port) throw new Error(`Port ${defaultPort} not available.`);\n    else return port;\n  } catch (error) {\n    throw new XDLError('NO_PORT_FOUND', 'No available port found: ' + error.message);\n  }\n}\n\nexport function setMode(mode: 'development' | 'production' | 'test' | 'none'): void {\n  process.env.BABEL_ENV = mode;\n  process.env.NODE_ENV = mode;\n}\n\nfunction validateBoolOption(name: string, value: unknown, defaultValue: boolean): boolean {\n  if (typeof value === 'undefined') {\n    value = defaultValue;\n  }\n\n  if (typeof value !== 'boolean') {\n    throw new XDLError('WEBPACK_INVALID_OPTION', `'${name}' option must be a boolean.`);\n  }\n\n  return value;\n}\n\nfunction transformCLIOptions(options: CLIWebOptions): BundlingOptions {\n  // Transform the CLI flags into more explicit values\n  return {\n    ...options,\n    isImageEditingEnabled: options.pwa,\n    isPolyfillEnabled: options.polyfill,\n  };\n}\n\nasync function createWebpackConfigAsync(\n  projectRoot: string,\n  options: CLIWebOptions = {}\n): Promise<{ env: any; config: Web.WebpackConfiguration }> {\n  const fullOptions = transformCLIOptions(options);\n  if (validateBoolOption('isValidationEnabled', fullOptions.isValidationEnabled, true)) {\n    await Doctor.validateWebSupportAsync(projectRoot);\n  }\n\n  const env = await getWebpackConfigEnvFromBundlingOptionsAsync(projectRoot, fullOptions);\n\n  setMode(env.mode);\n\n  let config;\n  if (options.unimodulesOnly) {\n    const withUnimodules = require('@expo/webpack-config/withUnimodules');\n    config = await withUnimodules({}, env);\n  } else {\n    config = await Web.invokeWebpackConfigAsync(env);\n  }\n\n  return { env, config };\n}\n\nasync function applyOptionsToProjectSettingsAsync(\n  projectRoot: string,\n  options: BundlingOptions\n): Promise<ProjectSettings.Settings> {\n  let newSettings: Partial<ProjectSettings.Settings> = {};\n  // Change settings before reading them\n  if (typeof options.https === 'boolean') {\n    newSettings.https = options.https;\n  }\n  if (typeof options.dev === 'boolean') {\n    newSettings.dev = options.dev;\n  }\n\n  if (Object.keys(newSettings).length) {\n    await ProjectSettings.setAsync(projectRoot, newSettings);\n  }\n\n  return await ProjectSettings.readAsync(projectRoot);\n}\n\nasync function getWebpackConfigEnvFromBundlingOptionsAsync(\n  projectRoot: string,\n  options: BundlingOptions\n): Promise<Web.WebEnvironment> {\n  let { dev, https } = await applyOptionsToProjectSettingsAsync(projectRoot, options);\n\n  const mode = typeof options.mode === 'string' ? options.mode : dev ? 'development' : 'production';\n\n  const isImageEditingEnabled = validateBoolOption(\n    'isImageEditingEnabled',\n    options.isImageEditingEnabled,\n    true\n  );\n  const isDebugInfoEnabled = validateBoolOption(\n    'isDebugInfoEnabled',\n    options.isDebugInfoEnabled,\n    Web.isInfoEnabled()\n  );\n\n  return {\n    projectRoot,\n    pwa: isImageEditingEnabled,\n    mode,\n    https,\n    polyfill: validateBoolOption('isPolyfillEnabled', options.isPolyfillEnabled, false),\n    development: dev,\n    production: !dev,\n    info: isDebugInfoEnabled,\n    ...(options.webpackEnv || {}),\n  };\n}\n\nasync function startNextJsAsync({\n  projectRoot,\n  port,\n  dev,\n  expoWebpackConfig,\n}: {\n  projectRoot: string;\n  port: number;\n  dev: boolean;\n  expoWebpackConfig: Web.WebpackConfiguration;\n}): Promise<DevServer> {\n  let next;\n  try {\n    const { exp } = await ConfigUtils.readConfigJsonAsync(projectRoot);\n    next = require(ConfigUtils.resolveModule('next', projectRoot, exp));\n  } catch {\n    throw new XDLError(\n      'NEXTJS_NOT_INSTALLED',\n      'Next.js is not installed in your app. See https://docs.expo.io/versions/latest/guides/using-nextjs/'\n    );\n  }\n\n  // Build first if in production mode.\n  // https://nextjs.org/docs#custom-server-and-routing\n  if (!dev) {\n    await bundleNextJsAsync({ projectRoot, expoWebpackConfig });\n  }\n\n  await _copyCustomNextJsTemplatesAsync(projectRoot);\n\n  const app = next({\n    dev,\n    dir: projectRoot,\n    conf: _createNextJsConfig({\n      projectRoot,\n      expoWebpackConfig,\n    }),\n  });\n  const handle = app.getRequestHandler();\n\n  await app.prepare();\n\n  const server = express();\n  server.get('*', handle);\n\n  webpackDevServerInstance = server.listen(port, err => {\n    if (err) {\n      throw new Error(`Express server failed to start: ${err.toString()}`);\n    }\n  });\n\n  return webpackDevServerInstance;\n}\n\nasync function bundleNextJsAsync({\n  projectRoot,\n  expoWebpackConfig,\n}: {\n  projectRoot: string;\n  expoWebpackConfig: Web.WebpackConfiguration;\n}) {\n  let nextBuild;\n  try {\n    const { exp } = await ConfigUtils.readConfigJsonAsync(projectRoot);\n    nextBuild = require(ConfigUtils.resolveModule('next/dist/build', projectRoot, exp)).default;\n  } catch {\n    throw new XDLError(\n      'NEXTJS_NOT_INSTALLED',\n      'Next.js (or its build component) is not installed in your app. See https://docs.expo.io/versions/latest/guides/using-nextjs/'\n    );\n  }\n\n  await _copyCustomNextJsTemplatesAsync(projectRoot);\n  await nextBuild(projectRoot, _createNextJsConfig({ projectRoot, expoWebpackConfig }));\n}\n\nfunction _createNextJsConfig({\n  projectRoot,\n  expoWebpackConfig,\n}: {\n  projectRoot: string;\n  expoWebpackConfig: Web.WebpackConfiguration;\n}): { [key: string]: any } {\n  let userNextJsConfig: any = {};\n  const userNextConfigJsPath = path.join(projectRoot, 'next.config.js');\n  if (fs.existsSync(userNextConfigJsPath)) {\n    userNextJsConfig = require(userNextConfigJsPath);\n  }\n\n  // `include` function is from https://github.com/expo/expo-cli/blob/3933f3d6ba65bffec2738ece71b62f2c284bd6e4/packages/webpack-config/webpack/loaders/createBabelLoaderAsync.js#L76-L96\n  const expoBabelLoader = _findBabelLoader(expoWebpackConfig.module!.rules);\n  if (!expoBabelLoader) {\n    throw new Error(\n      'Cannot find `babel-loader` generated by `@expo/webpack-config/withUnimodules`. It is likely an Expo issue. Please create a new issue at https://github.com/expo/expo-cli.'\n    );\n  }\n  const includeFunc = expoBabelLoader.include as ((path: string) => boolean);\n\n  return {\n    // https://github.com/zeit/next.js#configuring-extensions-looked-for-when-resolving-pages-in-pages\n    // Remove the `.` before each file extension\n    pageExtensions: expoWebpackConfig.resolve!.extensions!.map((string: string) =>\n      string.substr(1)\n    ),\n    ...userNextJsConfig,\n    // Note `webpack` has to come after `...userNextJsConfig` because we want to override that\n    // User's `webpack` config is loaded below in `return`.\n    webpack: (nextjsWebpackConfig: Web.WebpackConfiguration, options: any) => {\n      let newConfig = {\n        ...nextjsWebpackConfig,\n        module: {\n          ...nextjsWebpackConfig.module,\n          rules: [...nextjsWebpackConfig.module!.rules, ...expoWebpackConfig.module!.rules],\n        },\n        resolve: {\n          ...nextjsWebpackConfig.resolve,\n          symlinks: false,\n          extensions: expoWebpackConfig.resolve!.extensions,\n          alias: { ...nextjsWebpackConfig.resolve!.alias, ...expoWebpackConfig.resolve!.alias },\n        },\n        resolveLoader: { ...expoWebpackConfig.resolveLoader, ...nextjsWebpackConfig.resolveLoader },\n        plugins: [...nextjsWebpackConfig.plugins!, ...expoWebpackConfig.plugins!],\n      };\n\n      // We have to transpile these modules and make them not external too.\n      // We have to do this because next.js by default externals all `node_modules`'s js files.\n      // Reference:\n      // https://github.com/martpie/next-transpile-modules/blob/77450a0c0307e4b650d7acfbc18641ef9465f0da/index.js#L48-L62\n      // https://github.com/zeit/next.js/blob/0b496a45e85f3c9aa3cf2e77eef10888be5884fc/packages/next/build/webpack-config.ts#L185-L258\n      if (newConfig.externals) {\n        newConfig.externals = (newConfig.externals as any).map((external: any) => {\n          if (typeof external !== 'function') return external;\n          return (ctx: any, req: any, cb: any) => {\n            return includeFunc(path.join('node_modules', req)) ? cb() : external(ctx, req, cb);\n          };\n        });\n      }\n\n      // If the user has webpack config in their next.config.js, we provide our config to them.\n      // Reference: https://github.com/zeit/next-plugins/blob/8f9672dc0e189ffef5c99e588d40fa08d1d99d4f/packages/next-sass/index.js#L46-L50\n      if (typeof userNextJsConfig.webpack === 'function') {\n        return userNextJsConfig.webpack(newConfig, options);\n      }\n      return newConfig;\n    },\n  };\n}\n\nfunction _findBabelLoader(rules: webpack.RuleSetRule[]): webpack.RuleSetRule | null {\n  for (const rule of rules) {\n    if (\n      rule.use &&\n      (rule.use as any).loader &&\n      (rule.use as any).loader.includes('/babel-loader')\n    ) {\n      return rule;\n    }\n  }\n  return null;\n}\n\nasync function _copyCustomNextJsTemplatesAsync(projectRoot: string) {\n  try {\n    await fs.writeFile(path.join(projectRoot, '.expo', 'next_document.js'), nextJsDocument);\n  } catch (e) {\n    throw new Error(`Could not write to _document.js: ${e.toString()}`);\n  }\n\n  const pagesDocument = path.join(projectRoot, 'pages', '_document.js');\n  if (!fs.existsSync(pagesDocument)) {\n    // Only write to `pages/_document.js` if it doesn't exists.\n    try {\n      await fs.writeFile(pagesDocument, nextJsImportDocument);\n    } catch (e) {\n      throw new Error(`Could not write to pages/_document.js: ${e.toString()}`);\n    }\n  }\n}\n\nconst nextJsDocument = `\\\n// Based on https://github.com/zeit/next.js/tree/canary/examples/with-react-native-web\n// and https://github.com/expo/expo-cli/blob/master/packages/webpack-config/web-default/index.html\nimport Document, { Head, Main, NextScript } from 'next/document'\nimport React from 'react'\nimport { AppRegistry } from 'react-native'\n\nconst normalizeNextElements = \\`\n/**\n * Building on the RNWeb reset:\n * https://github.com/necolas/react-native-web/blob/master/packages/react-native-web/src/exports/StyleSheet/initialRules.js\n */\nhtml, body, #__next {\n  width: 100%;\n  /* To smooth any scrolling behavior */\n  -webkit-overflow-scrolling: touch;\n  margin: 0px;\n  padding: 0px;\n  /* Allows content to fill the viewport and go beyond the bottom */\n  min-height: 100%;\n}\n#__next {\n  flex-shrink: 0;\n  flex-basis: auto;\n  flex-grow: 1;\n  display: flex;\n  flex: 1;\n}\nhtml {\n  font-size: 14px;\n  scroll-behavior: smooth;\n  /* Prevent text size change on orientation change https://gist.github.com/tfausak/2222823#file-ios-8-web-app-html-L138 */\n  -webkit-text-size-adjust: 100%;\n  height: 100%;\n}\nbody {\n  display: flex;\n  /* Allows you to scroll below the viewport; default value is visible */\n  overflow-y: auto;\n  overscroll-behavior-y: none;\n  text-rendering: optimizeLegibility;\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n  -ms-overflow-style: scrollbar;\n}\n\\`;\n\nexport default class ExpoDocument extends Document {\n  static async getInitialProps ({ renderPage }) {\n    AppRegistry.registerComponent('Main', () => Main)\n    const { getStyleElement } = AppRegistry.getApplication('Main')\n    const page = renderPage()\n    const styles = [\n      <style dangerouslySetInnerHTML={{ __html: normalizeNextElements }} />,\n      getStyleElement()\n    ]\n    return { ...page, styles: React.Children.toArray(styles) }\n  }\n\n  render () {\n    return (\n      <html>\n        <Head>\n          <meta httpEquiv=\"X-UA-Compatible\" content=\"IE=edge\" />\n        </Head>\n        <body>\n          <Main />\n          <NextScript />\n        </body>\n      </html>\n    );\n  }\n}\n`;\n\nconst nextJsImportDocument = `\\\nimport ExpoDocument from '../.expo/next_document';\nexport default ExpoDocument;\n`;\n"],"file":"../Webpack.js","sourceRoot":"/@expo/xdl@56.2.1/src"}