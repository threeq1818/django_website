{"version":3,"sources":["detach/IosShellApp.js"],"names":["EXPOKIT_APP","EXPONENT_APP","_validateCLIArgs","args","type","configuration","verbose","testEnvironment","Error","action","url","sdkVersion","archivePath","async","_buildAsync","projectName","workspacePath","relativeBuildDestination","useModernBuildSystem","modernBuildSystemFragment","buildDest","let","buildCmd","pathToArtifact","path","join","logger","info","await","spawnAsyncThrowError","stdio","cwd","shell","resolve","_podInstallAsync","isRepoUpdateEnabled","pathsToClean","forEach","fs","existsSync","rimraf","sync","COCOAPODS_DISABLE_STATS","process","env","cocoapodsArgs","push","_createStandaloneContextAsync","expoSourcePath","workspaceSourcePath","privateConfigFile","privateConfigData","privateConfig","privateConfigContents","readFile","JSON","parse","manifest","withFields","buildPhase","stringify","releaseChannel","getManifestAsync","Accept","bundleExecutable","has","get","bundleIdentifier","pascalCase","buildFlags","StandaloneBuildFlags","createIos","appleTeamId","buildType","context","StandaloneContext","createServiceContext","shellAppSdkVersion","configureAndCopyArchiveAsync","output","IosNSBundle","configureAsync","workspaceName","build","ios","spawnAsync","pipeToLogger","data","loggerFields","archiveName","config","slug","replace","appReleasePath","stdoutOnly","_createTurtleWorkspaceAsync","skipRepoUpdate","_","IosWorkspace","createDetachedAsync","createTurtleWorkspaceAsync","buildAndCopyArtifactAsync","reuseWorkspace","getPaths","relative","parseSdkMajorVersion","artifactDestPath"],"mappings":"AAAA;AAEA;;;;;;;;;;AAEA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAEA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAMA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;;;;;AAEO,MAAMA,WAAAA,GAAc,YAApB;;AACA,MAAMC,YAAAA,GAAe,UAArB;;;AAEP,SAASC,gBAAT,CAA0BC,IAA1B,EAAgC;AAC9BA,EAAAA,IAAI,CAACC,IAALD,GAAYA,IAAI,CAACC,IAALD,IAAa,SAAzBA;AACAA,EAAAA,IAAI,CAACE,aAALF,GAAqBA,IAAI,CAACE,aAALF,IAAsB,SAA3CA;AACAA,EAAAA,IAAI,CAACG,OAALH,GAAeA,IAAI,CAACG,OAALH,IAAgB,KAA/BA;AACAA,EAAAA,IAAI,CAACI,eAALJ,GAAuBA,IAAI,CAACI,eAALJ,IAAwB,MAA/CA;;AAEA,UAAQA,IAAI,CAACC,IAAb;AACE,SAAK,WAAL;AAAkB;AAChB,YAAID,IAAI,CAACE,aAALF,KAAuB,OAAvBA,IAAkCA,IAAI,CAACE,aAALF,KAAuB,SAA7D,EAAwE;AACtE,gBAAM,IAAIK,KAAJ,CAAW,mCAAkCL,IAAI,CAACE,aAAc,EAAhE,CAAN;AACF;;AACA;AACF;;AACA,SAAK,SAAL;AAAgB;AACd,YAAIF,IAAI,CAACE,aAALF,KAAuB,SAA3B,EAAsC;AACpC,gBAAM,IAAIK,KAAJ,CAAU,4DAAV,CAAN;AACF;;AACA;AACF;;AACA,SAAK,QAAL;AACE;;AACF;AAAS;AACP,cAAM,IAAIA,KAAJ,CAAW,0BAAyBL,IAAI,CAACC,IAAK,EAA9C,CAAN;AACF;AAjBF;;AAoBA,UAAQD,IAAI,CAACM,MAAb;AACE,SAAK,WAAL;AAAkB;AAChB,YAAIN,IAAI,CAACC,IAALD,KAAc,QAAlB,EAA4B;AAC1B;AACF;;AAEA,YAAI,CAACA,IAAI,CAACO,GAAV,EAAe;AACb,gBAAM,IAAIF,KAAJ,CAAU,oCAAV,CAAN;AACF;;AACA,YAAI,CAACL,IAAI,CAACQ,UAAV,EAAsB;AACpB,gBAAM,IAAIH,KAAJ,CAAU,0CAAV,CAAN;AACF;;AACA,YAAI,CAACL,IAAI,CAACS,WAAV,EAAuB;AACrB,gBAAM,IAAIJ,KAAJ,CACJ,4EADI,CAAN;AAGF;;AACA,YACEL,IAAI,CAACI,eAALJ,KAAyB,OAAzBA,IACAA,IAAI,CAACI,eAALJ,KAAyB,IADzBA,IAEAA,IAAI,CAACI,eAALJ,KAAyB,MAH3B,EAIE;AACA,gBAAM,IAAIK,KAAJ,CAAW,gCAA+BL,IAAI,CAACI,eAAgB,EAA/D,CAAN;AACF;;AACA;AACF;;AACA,SAAK,OAAL;AAAc;AACZ;AACF;;AACA,SAAK,kBAAL;AAAyB;AACvB;AACF;;AACA;AAAS;AACP,cAAM,IAAIC,KAAJ,CAAW,4BAA2BL,IAAI,CAACM,MAAO,EAAlD,CAAN;AACF;AAlCF;;AAqCA,SAAON,IAAP;AACF;AAEA;;;;;;AAIAU,eAAeC,WAAfD,CACEE,WADFF,EAEEG,aAFFH,EAGER,aAHFQ,EAIET,IAJFS,EAKEI,wBALFJ,EAMEP,OANFO,EAOEK,oBAAAA,GAAuB,KAPzBL,EAQE;AACA,QAAMM,yBAAAA,GAA6B,yBAAwBD,oBAAAA,GAAuB,KAAvBA,GAA+B,IAAK,EAA/F;AACA,QAAME,SAAAA,GAAa,GAAEH,wBAAyB,IAAGb,IAAK,EAAtD;AACAiB,MAAIC,QAAAA,GAAY,4CAA2CP,WAAY,wBAAuBA,WAAY,mBAAkBV,aAAc,qBAAoBe,SAAU,IAAGD,yBAA0B,EAArME;AAAAA,MACEE,cADFF;;AAEA,MAAIjB,IAAAA,KAAS,WAAb,EAA0B;AACxBkB,IAAAA,QAAAA,IAAa,yHAAbA;AACAC,IAAAA,cAAAA,GAAiBC,gBAAKC,IAALD,CACfJ,SADeI,EAEf,OAFeA,EAGf,UAHeA,EAId,GAAEnB,aAAc,kBAJFmB,EAKd,GAAET,WAAY,MALAS,CAAjBD;AAOF,GATA,MASO,IAAInB,IAAAA,KAAS,SAAb,EAAwB;AAC7BkB,IAAAA,QAAAA,IAAa,yEAAwEF,SAAU,IAAGL,WAAY,+CAA9GO;AACAC,IAAAA,cAAAA,GAAiBC,gBAAKC,IAALD,CAAUJ,SAAVI,EAAsB,GAAET,WAAY,YAApCS,CAAjBD;AACF,GAHO,MAGA;AACL,UAAM,IAAIf,KAAJ,CAAW,2BAA0BJ,IAAK,EAA1C,CAAN;AACF;;AAEAsB,oBAAOC,IAAPD,CAAa,6BAA4BV,aAAc,OAAMI,SAAU,KAAvEM;;AACAA,oBAAOC,IAAPD,CAAYJ,QAAZI;;AACA,MAAI,CAACpB,OAAL,EAAc;AACZoB,sBAAOC,IAAPD,CACE,sFADFA;AAGF;;AACAE,QAAMC,2CAAqBP,QAArBO,EAA+B,IAA/BA,EAAqC;AACzC;AACAC,IAAAA,KAAK,EAAExB,OAAAA,GAAU,SAAVA,GAAsB,CAAC,QAAD,EAAW,QAAX,EAAqB,SAArB,CAFY;AAGzCyB,IAAAA,GAAG,EAAEf,aAHoC;AAIzCgB,IAAAA,KAAK,EAAE;AAJkC,GAArCH,CAAND;AAMA,SAAOJ,gBAAKS,OAALT,CAAaR,aAAbQ,EAA4BD,cAA5BC,CAAP;AACF;;AAEAX,eAAeqB,gBAAfrB,CAAgCG,aAAhCH,EAA+CsB,mBAA/CtB,EAAoE;AAClE;AACA,QAAMuB,YAAAA,GAAe,CAACZ,gBAAKC,IAALD,CAAUR,aAAVQ,EAAyB,MAAzBA,CAAD,EAAmCA,gBAAKC,IAALD,CAAUR,aAAVQ,EAAyB,cAAzBA,CAAnC,CAArB;AACAY,EAAAA,YAAY,CAACC,OAAbD,CAAqBZ,IAAAA,IAAQ;AAC3B,QAAIc,mBAAGC,UAAHD,CAAcd,IAAdc,CAAJ,EAAyB;AACvBE,wBAAOC,IAAPD,CAAYhB,IAAZgB;AACF;AACD,GAJDJ,EAHkE,CASlE;;AACA,QAAMM,uBAAAA,GAA0BC,OAAO,CAACC,GAARD,CAAYD,uBAA5C;AACAC,EAAAA,OAAO,CAACC,GAARD,CAAYD,uBAAZC,GAAsC,IAAtCA,CAXkE,CAalE;;AACAtB,MAAIwB,aAAAA,GAAgB,CAAC,SAAD,CAApBxB;;AACA,MAAIc,mBAAJ,EAAyB;AACvBU,IAAAA,aAAa,CAACC,IAAdD,CAAmB,eAAnBA;AACF;;AACAnB,oBAAOC,IAAPD,CAAY,0CAAZA;;AACAA,oBAAOC,IAAPD,CAAa,OAAMmB,aAAa,CAACpB,IAAdoB,CAAmB,GAAnBA,CAAwB,EAA3CnB;;AACA,MAAI;AACFE,UAAMC,2CAAqB,KAArBA,EAA4BgB,aAA5BhB,EAA2C;AAC/CC,MAAAA,KAAK,EAAE,SADwC;AAE/CC,MAAAA,GAAG,EAAEf;AAF0C,KAA3Ca,CAAND;AAIF,GALA,SAKU;AACR;AACAe,IAAAA,OAAO,CAACC,GAARD,CAAYD,uBAAZC,GAAsCD,uBAAtCC;AACF;AACF;AAEA;;;;;;;AAKA9B,eAAekC,6BAAflC,CAA6CV,IAA7CU,EAAmD;AACjD;AACA;AACA,QAAMmC,cAAAA,GAAiB7C,IAAI,CAAC6C,cAAL7C,IAAuB,QAA9C;AACAkB,MAAI4B,mBAAJ5B;;AACA,MAAIlB,IAAI,CAACa,aAAT,EAAwB;AACtBiC,IAAAA,mBAAAA,GAAsB9C,IAAI,CAACa,aAA3BiC;AACF,GAFA,MAEO;AACLA,IAAAA,mBAAAA,GAAsBzB,gBAAKC,IAALD,CAAUwB,cAAVxB,EAA0B,IAA1BA,EAAgC,oBAAhCA,EAAsD,SAAtDA,EAAiE,KAAjEA,CAAtByB;AACF;;AACA5B,MAAI;AAAE6B,IAAAA,iBAAF;AAAqBC,IAAAA;AAArB,MAA2ChD,IAA/CkB;AAEAA,MAAI+B,aAAJ/B;;AACA,MAAI8B,iBAAJ,EAAuB;AACrBC,IAAAA,aAAAA,GAAgBD,iBAAhBC;AACF,GAFA,MAEO,IAAIF,iBAAJ,EAAuB;AAC5B7B,QAAIgC,qBAAAA,GAAwBzB,MAAMU,mBAAGgB,QAAHhB,CAAYY,iBAAZZ,EAA+B,MAA/BA,CAAlCjB;AACA+B,IAAAA,aAAAA,GAAgBG,IAAI,CAACC,KAALD,CAAWF,qBAAXE,CAAhBH;AACF;;AAEA/B,MAAIoC,QAAJpC;;AACA,MAAIlB,IAAI,CAACsD,QAAT,EAAmB;AACjBA,IAAAA,QAAAA,GAAWtD,IAAI,CAACsD,QAAhBA;;AACA/B,sBACGgC,UADHhC,CACc;AAAEiC,MAAAA,UAAU,EAAE;AAAd,KADdjC,EAEGC,IAFHD,CAEQ,iBAFRA,EAE2B6B,IAAI,CAACK,SAALL,CAAeE,QAAfF,CAF3B7B;AAGF,GALA,MAKO,IAAIvB,IAAI,CAACO,GAALP,IAAYA,IAAI,CAACQ,UAArB,EAAiC;AACtC,UAAM;AAAED,MAAAA,GAAF;AAAOC,MAAAA,UAAP;AAAmBkD,MAAAA;AAAnB,QAAsC1D,IAA5C;AACAsD,IAAAA,QAAAA,GAAW7B,MAAMkC,uCAAiBpD,GAAjBoD,EAAsB;AACrC,8BAAwBnD,UADa;AAErC,2BAAqB,KAFgB;AAGrC,8BAAwBkD,cAAAA,GAAiBA,cAAjBA,GAAkC,SAHrB;AAIrCE,MAAAA,MAAM,EAAE;AAJ6B,KAAtBD,CAAjBL;AAMF;;AAEApC,MAAI2C,gBAAAA,GAAmB7D,IAAI,CAACC,IAALD,KAAc,QAAdA,GAAyBF,YAAzBE,GAAwCH,WAA/DqB;;AACA,MAAI4C,oBAAIR,QAAJQ,EAAc,kCAAdA,CAAJ,EAAuD;AACrDD,IAAAA,gBAAAA,GAAmBE,oBAAIT,QAAJS,EAAc,kCAAdA,CAAnBF;AACF,GAFA,MAEO,IAAIZ,aAAAA,IAAiBA,aAAa,CAACe,gBAAnC,EAAqD;AAC1DH,IAAAA,gBAAAA,GAAmBI,2BAAWhB,aAAa,CAACe,gBAAzBC,CAAnBJ;AACF;;AAEA,QAAMK,UAAAA,GAAaC,gCAAqBC,SAArBD,CAA+BnE,IAAI,CAACE,aAApCiE,EAAmD;AACpErB,IAAAA,mBADoE;AAEpEuB,IAAAA,WAAW,EAAErE,IAAI,CAACqE,WAFkD;AAGpEC,IAAAA,SAAS,EAAEtE,IAAI,CAACC,IAHoD;AAIpE4D,IAAAA;AAJoE,GAAnDM,CAAnB;;AAMA,QAAMI,OAAAA,GAAUC,6BAAkBC,oBAAlBD,CACd3B,cADc2B,EAEdxE,IAAI,CAACS,WAFS+D,EAGdlB,QAHckB,EAIdvB,aAJcuB,EAKdxE,IAAI,CAACI,eALSoE,EAMdN,UANcM,EAOdxE,IAAI,CAACO,GAPSiE,EAQdxE,IAAI,CAAC0D,cARSc,EASdxE,IAAI,CAAC0E,kBATSF,CAAhB;;AAWA,SAAOD,OAAP;AACF;AAEA;;;;;;;;;;;;;;AAYA7D,eAAeiE,4BAAfjE,CAA4CV,IAA5CU,EAAkD;AAChDV,EAAAA,IAAAA,GAAOD,gBAAgB,CAACC,IAAD,CAAvBA;AACA,QAAM;AAAE4E,IAAAA,MAAF;AAAU3E,IAAAA;AAAV,MAAmBD,IAAzB;AACA,QAAMuE,OAAAA,GAAU9C,MAAMmB,6BAA6B,CAAC5C,IAAD,CAAnD;AACAyB,QAAMoD,WAAW,GAACC,cAAZD,CAA2BN,OAA3BM,CAANpD;;AACA,MAAImD,MAAJ,EAAY;AACV,UAAMG,aAAAA,GAAgB9E,IAAAA,KAAS,QAATA,GAAoBH,YAApBG,GAAmCJ,WAAzD;;AACA,QAAI0E,OAAO,CAACS,KAART,CAAcU,GAAdV,CAAkBV,gBAAlBU,KAAuCQ,aAA3C,EAA0D;AACxDtD,YAAMyD,iCAAW,SAAXA,EAAsB,CAACH,aAAD,EAAgBR,OAAO,CAACS,KAART,CAAcU,GAAdV,CAAkBV,gBAAlC,CAAtBqB,EAA2E;AAC/EC,QAAAA,YAAY,EAAE,IADiE;AAE/EvD,QAAAA,GAAG,EAAE2C,OAAO,CAACa,IAARb,CAAa9D,WAF6D;AAG/E4E,QAAAA,YAAY,EAAE;AAAE7B,UAAAA,UAAU,EAAE;AAAd;AAHiE,OAA3E0B,CAANzD;AAKF;;AACA,QAAIxB,IAAAA,KAAS,WAAb,EAA0B;AACxB,YAAMqF,WAAAA,GAAcf,OAAO,CAACgB,MAARhB,CAAeiB,IAAfjB,CAAoBkB,OAApBlB,CAA4B,eAA5BA,EAA6C,GAA7CA,CAApB;;AACA,YAAMmB,cAAAA,GAAiBrE,gBAAKS,OAALT,CAAakD,OAAO,CAACa,IAARb,CAAa9D,WAA1BY,EAAuC,IAAvCA,CAAvB;;AACAI,YAAMyD,iCACH,MAAKH,aAAc,QAAOO,WAAY,qBAAoBV,MAAO,IAAGU,WAAY,MAD7EJ,EAEJ,IAFIA,EAGJ;AACES,QAAAA,UAAU,EAAE,IADd;AAEER,QAAAA,YAAY,EAAE,IAFhB;AAGEE,QAAAA,YAAY,EAAE;AAAE7B,UAAAA,UAAU,EAAE;AAAd,SAHhB;AAIE5B,QAAAA,GAAG,EAAE8D,cAJP;AAKE7D,QAAAA,KAAK,EAAE;AALT,OAHIqD,CAANzD;AAWF,KAdA,MAcO,IAAIxB,IAAAA,KAAS,SAATA,IAAsBA,IAAAA,KAAS,QAAnC,EAA6C;AAClDwB,YAAMyD,iCAAW,SAAXA,EAAsB,CAAE,GAAEH,aAAc,YAAlB,EAA+BH,MAA/B,CAAtBM,EAA8D;AAClEC,QAAAA,YAAY,EAAE,IADoD;AAElEvD,QAAAA,GAAG,EAAEP,gBAAKC,IAALD,CAAUkD,OAAO,CAACa,IAARb,CAAa9D,WAAvBY,EAAoC,aAApCA,CAF6D;AAGlEgE,QAAAA,YAAY,EAAE;AAAE7B,UAAAA,UAAU,EAAE;AAAd;AAHoD,OAA9D0B,CAANzD;AAKF;AACF;;AACA,SAAO8C,OAAO,CAACa,IAARb,CAAajB,QAApB;AACF;AAEA;;;;;;AAIA5C,eAAekF,2BAAflF,CAA2C6D,OAA3C7D,EAAoDV,IAApDU,EAA0D;AACxD,QAAM;AAAEmF,IAAAA;AAAF,MAAqB7F,IAA3B;;AACA,MAAImC,mBAAGC,UAAHD,CAAcoC,OAAO,CAACS,KAART,CAAcU,GAAdV,CAAkBzB,mBAAhCX,CAAJ,EAA0D;AACxDZ,sBAAOC,IAAPD,CAAa,kCAAiCgD,OAAO,CAACS,KAART,CAAcU,GAAdV,CAAkBzB,mBAAoB,KAApFvB;;AACA,QAAI;AACFc,wBAAOC,IAAPD,CAAYkC,OAAO,CAACS,KAART,CAAcU,GAAdV,CAAkBzB,mBAA9BT;AACF,KAFA,CAEE,OAAOyD,CAAP,EAAU,CAAC;AACf;;AACArE,QAAMsE,YAAY,GAACC,mBAAbD,CAAiCxB,OAAjCwB,CAANtE;AACAA,QAAMM,gBAAgB,CAACwC,OAAO,CAACS,KAART,CAAcU,GAAdV,CAAkBzB,mBAAnB,EAAwC,CAAC+C,cAAzC,CAAtBpE;AACF;AAEA;;;;;;;;;;AAQAf,eAAeuF,0BAAfvF,CAA0CV,IAA1CU,EAAgD;AAC9CV,EAAAA,IAAAA,GAAOD,gBAAgB,CAACC,IAAD,CAAvBA;;AACA,MAAI,CAACA,IAAI,CAACa,aAAV,EAAyB;AACvBU,sBAAOC,IAAPD,CACE,mFADFA;AAGF;;AACA,QAAMgD,OAAAA,GAAU9C,MAAMmB,6BAA6B,CAAC5C,IAAD,CAAnD;AACAyB,QAAMmE,2BAA2B,CAACrB,OAAD,EAAUvE,IAAV,CAAjCyB;;AACAF,oBAAOC,IAAPD,CACG,+BAA8BgD,OAAO,CAACS,KAART,CAAcU,GAAdV,CAC5BzB,mBAAoB,uCAFzBvB;;AAIA,MAAIgD,OAAO,CAACgB,MAAZ,EAAoB;AAClB9D,UAAMoD,WAAW,GAACC,cAAZD,CAA2BN,OAA3BM,CAANpD;;AACAF,sBAAOC,IAAPD,CACG,mDAAkDvB,IAAI,CAACO,GAAI,wGAD9DgB;AAGF,GALA,MAKO;AACLA,sBAAOC,IAAPD,CACG,uYADHA;AAGF;AACF;AAEA;;;;;;;;;;AAQAb,eAAewF,yBAAfxF,CAAyCV,IAAzCU,EAA+C;AAC7CV,EAAAA,IAAAA,GAAOD,gBAAgB,CAACC,IAAD,CAAvBA;AACA,QAAMuE,OAAAA,GAAU9C,MAAMmB,6BAA6B,CAAC5C,IAAD,CAAnD;AACA,QAAM;AAAEG,IAAAA,OAAF;AAAWF,IAAAA,IAAX;AAAiBkG,IAAAA;AAAjB,MAAoCnG,IAA1C;AACA,QAAM;AAAEY,IAAAA;AAAF,MAAkBmF,YAAY,GAACK,QAAbL,CAAsBxB,OAAtBwB,CAAxB;;AAEA,MAAI,CAACI,cAAL,EAAqB;AACnB1E,UAAMmE,2BAA2B,CAACrB,OAAD,EAAUvE,IAAV,CAAjCyB;AACF;;AACA,QAAML,cAAAA,GAAiBK,MAAMd,WAAW,CACtCC,WADsC,EAEtC2D,OAAO,CAACS,KAART,CAAcU,GAAdV,CAAkBzB,mBAFoB,EAGtCyB,OAAO,CAACS,KAART,CAAcrE,aAHwB,EAItCD,IAJsC,EAKtCoB,gBAAKgF,QAALhF,CAAckD,OAAO,CAACS,KAART,CAAcU,GAAdV,CAAkBzB,mBAAhCzB,EAAqD,iBAArDA,CALsC,EAMtClB,OANsC,EAOtCmG,2CAAqBtG,IAAI,CAAC0E,kBAA1B4B,IAAgD,EAPV,CAAxC;;AASA,QAAMC,gBAAAA,GAAmBlF,gBAAKC,IAALD,CAAU,wBAAVA,EAAoCpB,IAApCoB,EAA0CkD,OAAO,CAACS,KAART,CAAcrE,aAAxDmB,CAAzB;;AACAE,oBAAOC,IAAPD,CAAa,4CAA2CF,gBAAKS,OAALT,CAAakF,gBAAblF,CAA+B,KAAvFE;;AACA,MAAIY,mBAAGC,UAAHD,CAAcoE,gBAAdpE,CAAJ,EAAqC;AACnCV,UAAMC,2CAAqB,SAArBA,EAAgC,CAAC,KAAD,EAAQ6E,gBAAR,CAAhC7E,CAAND;AACF;;AACAF,oBAAOC,IAAPD,CAAa,YAAWgF,gBAAiB,EAAzChF;;AACAE,QAAMC,2CAAqB,YAArBA,EAAmC,CAAC,IAAD,EAAO6E,gBAAP,CAAnC7E,CAAND;;AACAF,oBAAOC,IAAPD,CAAa,SAAQH,cAAe,IAAGmF,gBAAiB,EAAxDhF;;AACAE,QAAMC,2CAAqB,SAArBA,EAAgC,CAAC,IAAD,EAAON,cAAP,EAAuBmF,gBAAvB,CAAhC7E,CAAND;AACF","file":"../../detach/IosShellApp.js","sourcesContent":["// Copyright 2015-present 650 Industries. All rights reserved.\n\n'use strict';\n\nimport fs from 'fs-extra';\nimport path from 'path';\nimport rimraf from 'rimraf';\nimport get from 'lodash/get';\nimport has from 'lodash/has';\nimport pascalCase from 'pascal-case';\n\nimport {\n  getManifestAsync,\n  spawnAsync,\n  spawnAsyncThrowError,\n  parseSdkMajorVersion,\n} from './ExponentTools';\nimport * as IosNSBundle from './IosNSBundle';\nimport * as IosWorkspace from './IosWorkspace';\nimport StandaloneBuildFlags from './StandaloneBuildFlags';\nimport StandaloneContext from './StandaloneContext';\nimport logger from './Logger';\n\nexport const EXPOKIT_APP = 'ExpoKitApp';\nexport const EXPONENT_APP = 'Exponent';\n\nfunction _validateCLIArgs(args) {\n  args.type = args.type || 'archive';\n  args.configuration = args.configuration || 'Release';\n  args.verbose = args.verbose || false;\n  args.testEnvironment = args.testEnvironment || 'none';\n\n  switch (args.type) {\n    case 'simulator': {\n      if (args.configuration !== 'Debug' && args.configuration !== 'Release') {\n        throw new Error(`Unsupported build configuration ${args.configuration}`);\n      }\n      break;\n    }\n    case 'archive': {\n      if (args.configuration !== 'Release') {\n        throw new Error('Release is the only supported configuration when archiving');\n      }\n      break;\n    }\n    case 'client':\n      break;\n    default: {\n      throw new Error(`Unsupported build type ${args.type}`);\n    }\n  }\n\n  switch (args.action) {\n    case 'configure': {\n      if (args.type === 'client') {\n        break;\n      }\n\n      if (!args.url) {\n        throw new Error('Must run with `--url MANIFEST_URL`');\n      }\n      if (!args.sdkVersion) {\n        throw new Error('Must run with `--sdkVersion SDK_VERSION`');\n      }\n      if (!args.archivePath) {\n        throw new Error(\n          'Need to provide --archivePath <path to existing archive for configuration>'\n        );\n      }\n      if (\n        args.testEnvironment !== 'local' &&\n        args.testEnvironment !== 'ci' &&\n        args.testEnvironment !== 'none'\n      ) {\n        throw new Error(`Unsupported test environment ${args.testEnvironment}`);\n      }\n      break;\n    }\n    case 'build': {\n      break;\n    }\n    case 'create-workspace': {\n      break;\n    }\n    default: {\n      throw new Error(`Unsupported build action ${args.action}`);\n    }\n  }\n\n  return args;\n}\n\n/**\n *  Build the iOS workspace at the given path.\n *  @return the path to the resulting build artifact\n */\nasync function _buildAsync(\n  projectName,\n  workspacePath,\n  configuration,\n  type,\n  relativeBuildDestination,\n  verbose,\n  useModernBuildSystem = false\n) {\n  const modernBuildSystemFragment = `-UseModernBuildSystem=${useModernBuildSystem ? 'YES' : 'NO'}`;\n  const buildDest = `${relativeBuildDestination}-${type}`;\n  let buildCmd = `set -o pipefail && xcodebuild -workspace ${projectName}.xcworkspace -scheme ${projectName} -configuration ${configuration} -derivedDataPath ${buildDest} ${modernBuildSystemFragment}`,\n    pathToArtifact;\n  if (type === 'simulator') {\n    buildCmd += ` -sdk iphonesimulator CODE_SIGN_IDENTITY=\"\" CODE_SIGNING_REQUIRED=NO ARCHS=\"i386 x86_64\" ONLY_ACTIVE_ARCH=NO | xcpretty`;\n    pathToArtifact = path.join(\n      buildDest,\n      'Build',\n      'Products',\n      `${configuration}-iphonesimulator`,\n      `${projectName}.app`\n    );\n  } else if (type === 'archive') {\n    buildCmd += ` -sdk iphoneos -destination generic/platform=iOS archive -archivePath ${buildDest}/${projectName}.xcarchive CODE_SIGNING_ALLOWED=NO | xcpretty`;\n    pathToArtifact = path.join(buildDest, `${projectName}.xcarchive`);\n  } else {\n    throw new Error(`Unsupported build type: ${type}`);\n  }\n\n  logger.info(`Building iOS workspace at ${workspacePath} to ${buildDest}:\\n`);\n  logger.info(buildCmd);\n  if (!verbose) {\n    logger.info(\n      '\\nxcodebuild is running. Logging errors only. To see full output, use --verbose 1...'\n    );\n  }\n  await spawnAsyncThrowError(buildCmd, null, {\n    // only stderr\n    stdio: verbose ? 'inherit' : ['ignore', 'ignore', 'inherit'],\n    cwd: workspacePath,\n    shell: true,\n  });\n  return path.resolve(workspacePath, pathToArtifact);\n}\n\nasync function _podInstallAsync(workspacePath, isRepoUpdateEnabled) {\n  // ensure pods are clean\n  const pathsToClean = [path.join(workspacePath, 'Pods'), path.join(workspacePath, 'Podfile.lock')];\n  pathsToClean.forEach(path => {\n    if (fs.existsSync(path)) {\n      rimraf.sync(path);\n    }\n  });\n\n  // Disable cocoapod stats to speed up the install\n  const COCOAPODS_DISABLE_STATS = process.env.COCOAPODS_DISABLE_STATS;\n  process.env.COCOAPODS_DISABLE_STATS = true;\n\n  // install\n  let cocoapodsArgs = ['install'];\n  if (isRepoUpdateEnabled) {\n    cocoapodsArgs.push('--repo-update');\n  }\n  logger.info('Installing iOS workspace dependencies...');\n  logger.info(`pod ${cocoapodsArgs.join(' ')}`);\n  try {\n    await spawnAsyncThrowError('pod', cocoapodsArgs, {\n      stdio: 'inherit',\n      cwd: workspacePath,\n    });\n  } finally {\n    // Revert the stats to the user preference\n    process.env.COCOAPODS_DISABLE_STATS = COCOAPODS_DISABLE_STATS;\n  }\n}\n\n/**\n * @param workspacePath optionally provide a path for the unbuilt xcode workspace to create/use.\n * @param expoSourcePath path to expo client app sourcecode (/ios dir from expo/expo repo)\n * @param shellAppSdkVersion sdk version for shell app\n */\nasync function _createStandaloneContextAsync(args) {\n  // right now we only ever build a single detached workspace for service contexts.\n  // TODO: support multiple different pod configurations, assemble a cache of those builds.\n  const expoSourcePath = args.expoSourcePath || '../ios';\n  let workspaceSourcePath;\n  if (args.workspacePath) {\n    workspaceSourcePath = args.workspacePath;\n  } else {\n    workspaceSourcePath = path.join(expoSourcePath, '..', 'shellAppWorkspaces', 'default', 'ios');\n  }\n  let { privateConfigFile, privateConfigData } = args;\n\n  let privateConfig;\n  if (privateConfigData) {\n    privateConfig = privateConfigData;\n  } else if (privateConfigFile) {\n    let privateConfigContents = await fs.readFile(privateConfigFile, 'utf8');\n    privateConfig = JSON.parse(privateConfigContents);\n  }\n\n  let manifest;\n  if (args.manifest) {\n    manifest = args.manifest;\n    logger\n      .withFields({ buildPhase: 'reading manifest' })\n      .info('Using manifest:', JSON.stringify(manifest));\n  } else if (args.url && args.sdkVersion) {\n    const { url, sdkVersion, releaseChannel } = args;\n    manifest = await getManifestAsync(url, {\n      'Exponent-SDK-Version': sdkVersion,\n      'Exponent-Platform': 'ios',\n      'Expo-Release-Channel': releaseChannel ? releaseChannel : 'default',\n      Accept: 'application/expo+json,application/json',\n    });\n  }\n\n  let bundleExecutable = args.type === 'client' ? EXPONENT_APP : EXPOKIT_APP;\n  if (has(manifest, 'ios.infoPlist.CFBundleExecutable')) {\n    bundleExecutable = get(manifest, 'ios.infoPlist.CFBundleExecutable');\n  } else if (privateConfig && privateConfig.bundleIdentifier) {\n    bundleExecutable = pascalCase(privateConfig.bundleIdentifier);\n  }\n\n  const buildFlags = StandaloneBuildFlags.createIos(args.configuration, {\n    workspaceSourcePath,\n    appleTeamId: args.appleTeamId,\n    buildType: args.type,\n    bundleExecutable,\n  });\n  const context = StandaloneContext.createServiceContext(\n    expoSourcePath,\n    args.archivePath,\n    manifest,\n    privateConfig,\n    args.testEnvironment,\n    buildFlags,\n    args.url,\n    args.releaseChannel,\n    args.shellAppSdkVersion\n  );\n  return context;\n}\n\n/**\n * possible args:\n *  @param url manifest url for shell experience\n *  @param sdkVersion sdk to use when requesting the manifest\n *  @param releaseChannel channel to pull manifests from, default is 'default'\n *  @param archivePath path to existing NSBundle to configure\n *  @param privateConfigFile path to a private config file containing, e.g., private api keys\n *  @param appleTeamId Apple Developer's account Team ID\n *  @param output specify the output path of the configured archive (ie) /tmp/my-app-archive-build.xcarchive or /tmp/my-app-ios-build.tar.gz\n *  @param type type of artifact to configure (simulator or archive)\n *  @param expoSourcePath path to expo client app sourcecode (/ios dir from expo/expo repo)\n */\nasync function configureAndCopyArchiveAsync(args) {\n  args = _validateCLIArgs(args);\n  const { output, type } = args;\n  const context = await _createStandaloneContextAsync(args);\n  await IosNSBundle.configureAsync(context);\n  if (output) {\n    const workspaceName = type === 'client' ? EXPONENT_APP : EXPOKIT_APP;\n    if (context.build.ios.bundleExecutable !== workspaceName) {\n      await spawnAsync('/bin/mv', [workspaceName, context.build.ios.bundleExecutable], {\n        pipeToLogger: true,\n        cwd: context.data.archivePath,\n        loggerFields: { buildPhase: 'renaming bundle executable' },\n      });\n    }\n    if (type === 'simulator') {\n      const archiveName = context.config.slug.replace(/[^0-9a-z_-]/gi, '_');\n      const appReleasePath = path.resolve(context.data.archivePath, '..');\n      await spawnAsync(\n        `mv ${workspaceName}.app ${archiveName}.app && tar -czvf ${output} ${archiveName}.app`,\n        null,\n        {\n          stdoutOnly: true,\n          pipeToLogger: true,\n          loggerFields: { buildPhase: 'creating an archive for simulator' },\n          cwd: appReleasePath,\n          shell: true,\n        }\n      );\n    } else if (type === 'archive' || type === 'client') {\n      await spawnAsync('/bin/mv', [`${workspaceName}.xcarchive`, output], {\n        pipeToLogger: true,\n        cwd: path.join(context.data.archivePath, '../../../..'),\n        loggerFields: { buildPhase: 'renaming archive' },\n      });\n    }\n  }\n  return context.data.manifest;\n}\n\n/**\n * possible args:\n *  @param skipRepoUpdate if true, omit `--repo-update` cocoapods flag.\n */\nasync function _createTurtleWorkspaceAsync(context, args) {\n  const { skipRepoUpdate } = args;\n  if (fs.existsSync(context.build.ios.workspaceSourcePath)) {\n    logger.info(`Removing existing workspace at ${context.build.ios.workspaceSourcePath}...`);\n    try {\n      rimraf.sync(context.build.ios.workspaceSourcePath);\n    } catch (_) {}\n  }\n  await IosWorkspace.createDetachedAsync(context);\n  await _podInstallAsync(context.build.ios.workspaceSourcePath, !skipRepoUpdate);\n}\n\n/**\n * External-facing version can be used to create a turtle workspace without building it.\n * Probably only useful for local testing.\n *\n * @param workspacePath (optional) provide some other path to create the workspace besides the default\n * @param url (optional, with sdkVersion) url to an expo manifest, if you want the workspace to be configured automatically\n * @param sdkVersion (optional, with url) sdkVersion to an expo manifest, if you want the workspace to be configured automatically\n */\nasync function createTurtleWorkspaceAsync(args) {\n  args = _validateCLIArgs(args);\n  if (!args.workspacePath) {\n    logger.info(\n      'No workspace path was provided with --workspacePath, so the default will be used.'\n    );\n  }\n  const context = await _createStandaloneContextAsync(args);\n  await _createTurtleWorkspaceAsync(context, args);\n  logger.info(\n    `Created turtle workspace at ${context.build.ios\n      .workspaceSourcePath}. You can open and run this in Xcode.`\n  );\n  if (context.config) {\n    await IosNSBundle.configureAsync(context);\n    logger.info(\n      `The turtle workspace was configured for the url ${args.url}. To run this app with a Debug scheme, make sure to add a development url to 'EXBuildConstants.plist'.`\n    );\n  } else {\n    logger.info(\n      `You can specify --url <manifestUrl> --sdkVersion <version> to configure this workspace as a particular Expo app.\\n\\nBecause those arguments were omitted, the workspace has not been configured. It will compile but not run. The minimum configuration to get something running is to specify a manifest url in 'EXShell.plist' (for Release builds) or 'EXBuildConstants.plist' (for Debug builds).`\n    );\n  }\n}\n\n/**\n * possible args:\n *  @param configuration StandaloneBuildConfiguration (Debug or Release)\n *  @param verbose show all xcodebuild output (default false)\n *  @param reuseWorkspace if true, when building, assume a detached workspace already exists rather than creating a new one.\n *  @param type type of artifact to build (simulator or archive)\n *  @param shellAppSdkVersion sdk version for shell app\n */\nasync function buildAndCopyArtifactAsync(args) {\n  args = _validateCLIArgs(args);\n  const context = await _createStandaloneContextAsync(args);\n  const { verbose, type, reuseWorkspace } = args;\n  const { projectName } = IosWorkspace.getPaths(context);\n\n  if (!reuseWorkspace) {\n    await _createTurtleWorkspaceAsync(context, args);\n  }\n  const pathToArtifact = await _buildAsync(\n    projectName,\n    context.build.ios.workspaceSourcePath,\n    context.build.configuration,\n    type,\n    path.relative(context.build.ios.workspaceSourcePath, '../shellAppBase'),\n    verbose,\n    parseSdkMajorVersion(args.shellAppSdkVersion) > 33\n  );\n  const artifactDestPath = path.join('../shellAppBase-builds', type, context.build.configuration);\n  logger.info(`\\nFinished building, copying artifact to ${path.resolve(artifactDestPath)}...`);\n  if (fs.existsSync(artifactDestPath)) {\n    await spawnAsyncThrowError('/bin/rm', ['-rf', artifactDestPath]);\n  }\n  logger.info(`mkdir -p ${artifactDestPath}`);\n  await spawnAsyncThrowError('/bin/mkdir', ['-p', artifactDestPath]);\n  logger.info(`cp -R ${pathToArtifact} ${artifactDestPath}`);\n  await spawnAsyncThrowError('/bin/cp', ['-R', pathToArtifact, artifactDestPath]);\n}\n\nexport { buildAndCopyArtifactAsync, configureAndCopyArchiveAsync, createTurtleWorkspaceAsync };\n"],"sourceRoot":"/@expo/xdl@56.2.1/src"}